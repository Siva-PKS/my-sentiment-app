name: Update Top Referrers in README
on:
  schedule:
    - cron: "23 0 * * *"   # daily
  workflow_dispatch:
permissions:
  contents: write
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            let list = [];
            try {
              const { data } = await github.request('GET /repos/{owner}/{repo}/traffic/popular/referrers', { owner, repo });
              list = data || [];
            } catch (e) {
              core.warning(`Referrers API error: ${e.status||''} ${e.message}`);
            }
            const lines = list.length
              ? list.map(r => `- **${r.referrer}** â€” ${r.count} views (${r.uniques} unique)`)
              : ['- (no data in the last 14 days)'];
            const stamp = new Date().toISOString().replace('T',' ').replace('Z',' UTC');
            const block = [`Last updated: **${stamp}**`, '', ...lines].join('\n');
            const fs = require('fs');
            const path = 'README.md';
            if (!fs.existsSync(path)) core.setFailed('README.md not found');
            let md = fs.readFileSync(path, 'utf8');
            const START='<!-- REFERRERS:START -->', END='<!-- REFERRERS:END -->';
            const re = new RegExp(`${START}[\\s\\S]*?${END}`);
            md = re.test(md) ? md.replace(re, `${START}\n${block}\n${END}`) : md + `\n\n## ðŸ”— Top Referrers (last 14 days)\n${START}\n${block}\n${END}\n`;
            fs.writeFileSync(path, md, 'utf8');
            const get = await github.request('GET /repos/{owner}/{repo}/contents/{path}', { owner, repo, path });
            await github.request('PUT /repos/{owner}/{repo}/contents/{path}', {
              owner, repo, path,
              message: 'docs: update top referrers in README [bot]',
              content: Buffer.from(md, 'utf8').toString('base64'),
              sha: get.data.sha
            });
